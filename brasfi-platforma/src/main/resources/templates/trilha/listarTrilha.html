<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Trilhas de Conhecimento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" th:href="@{/css/time-picker.css}" />
    <link rel="stylesheet" th:href="@{/css/eixo-picker.css}" />
    <link rel="stylesheet" th:href="@{/css/adicionar-aula.css}" />
    <style>
        /* General Modal Overlay */
.custom-modal-overlay {
    position: fixed; /* Stays in place relative to the viewport */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent black background */
    display: flex; /* Use flexbox for centering */
    justify-content: center; /* Center horizontally */
    align-items: center; /* Center vertically */
    z-index: 1050; /* Ensure it's on top of most other content */
    overflow-y: auto; /* Allow scrolling if content is too tall */
}

/* Class to hide the modal */
.custom-modal-overlay.hidden {
    display: none;
}

/* Modal Content Box */
.custom-modal-content {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    max-width: 500px; /* Max width for the modal */
    width: 90%; /* Responsive width */
    padding: 20px;
    position: relative; /* For potential absolute positioning of inner elements */
    box-sizing: border-box; /* Include padding in width/height */
}

/* Modal Body Section */
.custom-modal-body {
    padding: 15px 0; /* Add some vertical padding */
}

/* Modal Footer Section (for buttons) */
.custom-modal-footer {
    display: flex;
    justify-content: center; /* Center buttons horizontally */
    gap: 10px; /* Space between buttons */
    padding-top: 15px; /* Space above buttons */
    border-top: 1px solid #eee; /* Light line above buttons */
    margin-top: 20px; /* Space above the border */
}

    </style>
</head>
<body class="bg-gray-100">

<div class="flex h-screen">
    <aside class="w-60 bg-gray-200 p-6 flex flex-col gap-6">
        <div class="text-xl font-bold">BRASFI conecta</div>
        <nav class="flex flex-col gap-4">
            <button class="text-left text-lg font-medium">Dashboard</button>
            <button class="text-left text-lg font-medium">Trilhas</button>
            <button class="text-left text-lg font-medium">Grupos</button>
            <button class="text-left text-lg font-medium">Projetos</button>
        </nav>
    </aside>

    <main class="flex-1 p-6">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">Trilhas de conhecimento</h1>
            <div class="flex items-center gap-4">
                <input type="text" placeholder="Pesquisar por trilhas ou aulas" class="border border-gray-300 rounded-full px-4 py-2 w-80"/>
                <div class="flex items-center gap-2">
                    <span class="font-semibold">Usuário</span>
                    <span class="text-sm text-gray-500">Cargo</span>
                </div>
            </div>
        </div>

        <div class="flex gap-4 mb-6">
            <button class="bg-gray-300 px-4 py-2 rounded-full text-sm">Todos</button>
            <button class="bg-gray-300 px-4 py-2 rounded-full text-sm">Liderança</button>
            <button class="bg-gray-300 px-4 py-2 rounded-full text-sm">Finanças</button>
            <button class="bg-gray-300 px-4 py-2 rounded-full text-sm">Empreendedorismo</button>
            <button class="bg-gray-300 px-4 py-2 rounded-full text-sm">Saúde</button>
        </div>

        <div th:if="${cargoUsuario == 'ADMINISTRADOR'}" class="flex gap-3 justify-end mr-2">
            <button onclick="loadaddAulaModal().then(showAddAulaModal)"
                    class="rounded-md bg-[#65A603] text-white px-4 py-2 hover:bg-green-700 mb-6 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                Adicionar aula
            </button>

            <button id="openNewTrilhaModalBtn"
                    class="rounded-md bg-[#18290C] text-white px-4 py-2 hover:bg-green-700 mb-6 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                Criar Trilha
            </button>
        </div>

        <div class="flex gap-6">
            <div class="grid grid-cols-3 gap-4 w-3/4">

                <div th:each="trilha : ${trilhas}" class="bg-white p-4 rounded-lg shadow relative">
                    <div th:style="'background-image: url(' + ${trilha.capa ?: 'https://via.placeholder.com/150'} + ')'"
                         class="h-32 bg-gray-200 rounded mb-4 bg-cover bg-center"></div>

                    <span th:text="${trilha.eixoTematico != null ? trilha.eixoTematico.displayValue : 'N/A'}"
                          class="text-sm bg-gray-100 px-2 py-1 rounded text-gray-700"></span>

                    <div class="flex justify-between items-center mt-2">
                        <h2 th:text="${trilha.titulo}" class="font-semibold text-base"></h2>
                        <div class="relative">
                            <button th:id="'kebab-menu-btn-' + ${trilha.id}"
                                    class="text-gray-500 hover:text-gray-800 px-2"
                                    onclick="toggleKebabMenu(this, event)"> &#x22EE;
                            </button>
                            <div th:id="'kebab-menu-' + ${trilha.id}"
                                 class="absolute right-0 mt-2 bg-white border border-gray-200 rounded shadow-md hidden z-10">
                                <button class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                                        th:data-trilha-id="${trilha.id}"
                                        th:data-trilha-titulo="${trilha.titulo}"
                                        th:data-trilha-descricao="${trilha.descricao}"
                                        th:data-trilha-eixo="${trilha.eixoTematico}"
                                        th:data-trilha-duracao="${duracaoInput}"
                                        th:data-trilha-topicos="${trilha.topicosDeAprendizado}"
                                        onclick="openEditTrilhaModal(this)">
                                    Editar
                                </button>
                                <button class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-100"
                                        th:data-trilha-id="${trilha.id}"
                                        th:data-trilha-titulo="${trilha.titulo}"
                                        onclick="abrirDeletarModal(this.dataset.trilhaId, this.dataset.trilhaTitulo)">
                                    Deletar
                                </button>

                            </div>
                        </div>
                    </div>

                    <p th:text="${trilha.descricao}" class="text-sm text-gray-600"></p>
                    <div class="mt-2 text-yellow-500">★★★★☆ (123)</div>
                </div>

            </div>

            <aside class="w-1/4 bg-white p-4 rounded-lg shadow h-fit">
                <h3 class="font-semibold mb-4">Sugestões:</h3>
                <div class="mb-3">
                    <p class="text-sm text-gray-500">Aula 01: Nome da aula</p>
                    <p class="text-xs text-gray-400">Nome do curso</p>
                    <a href="#" class="text-blue-600 text-xs">Acessar ></a>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Aula 02: Por que Sustentabilidade Importa?</p>
                    <p class="text-xs text-gray-400">Introdução à Finanças Sustentáveis</p>
                    <a href="#" class="text-blue-600 text-xs">Acessar ></a>
                </div>
            </aside>
        </div>
    </main>
</div>

<div id="newTrilhaModalContainer"></div>
<div id="editTrilhaModalContainer"></div>
<div id="deleteTrilhaModalContainer"></div>
<div id="addAulaModalContainer"></div>

<script>
    // Function to toggle the kebab menu visibility
    function toggleKebabMenu(buttonElement, event) { // Added event parameter
        event.stopPropagation(); // Stop the event from bubbling up to the document

        const trilhaId = buttonElement.id.replace('kebab-menu-btn-', '');
        const menuDiv = document.getElementById('kebab-menu-' + trilhaId);

        if (menuDiv) {
            menuDiv.classList.toggle('hidden');
        }

        if (!menuDiv.classList.contains('hidden')) {
            // We only add it once and rely on it for all menus.
            // It's removed and re-added in the openEditTrilhaModal to ensure it's always active.
            // For simplicity, we can just ensure it's always there, but be mindful of many event listeners.
            // A better approach might be to ensure only one document listener exists at all times.
            document.addEventListener('click', closeKebabMenusOutside);
        } else {
            // If the menu is being closed, you might want to remove the global listener if no other menus are open
            const anyMenuOpen = Array.from(document.querySelectorAll('[id^="kebab-menu-"]'))
                                    .some(menu => !menu.classList.contains('hidden'));
            if (!anyMenuOpen) {
                document.removeEventListener('click', closeKebabMenusOutside);
            }
        }
    }

    // Function to close kebab menus when clicking outside
    function closeKebabMenusOutside(event) {
        let anyMenuWasOpen = false;
        document.querySelectorAll('[id^="kebab-menu-"]').forEach(menu => {
            const buttonId = 'kebab-menu-btn-' + menu.id.replace('kebab-menu-', '');
            const button = document.getElementById(buttonId);

            // If the click is outside the menu and its button, hide the menu
            if (menu && button && !menu.contains(event.target) && !button.contains(event.target) && !menu.classList.contains('hidden')) {
                menu.classList.add('hidden');
                anyMenuWasOpen = true; // Mark that at least one menu was closed
            }
        });

        // If no menus are open after this click, remove the global listener
        if (anyMenuWasOpen && !Array.from(document.querySelectorAll('[id^="kebab-menu-"]')).some(m => !m.classList.contains('hidden'))) {
            document.removeEventListener('click', closeKebabMenusOutside);
        }
    }

</script>
<script th:src="@{/js/criar-trilha.js}"></script>
<script th:src="@{/js/adicionar-aula.js}"></script>
<script th:src="@{/js/deletar-trilha.js}"></script>
<script th:src="@{/js/editar-trilha.js}"></script>

<script th:src="@{/js/eixo-picker.js}"></script>
<script th:src="@{/js/time-picker.js}"></script>

</body>
</html>