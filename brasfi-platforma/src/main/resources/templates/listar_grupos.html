<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"> <head>
    <title>Lista de Grupos</title>
    <meta charset="UTF-8" />
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        .avatar-group > img {
            margin-left: -8px; /* Overlap avatars */
            border: 2px solid white; /* Border for avatars */
        }
        .avatar-group > img:first-child {
            margin-left: 0;
        }

        .tab-button.active {
            /* CORRIGIDO para usar o novo verde */
            border-bottom: 2px solid #65a603;
            color: #65a603;
        }

        :root {
            /* CORRIGIDO para usar o novo verde */
            --color-brasfi-blue: #65a603;
            --color-gray-bg: #f8f8f8;
            --color-medium-gray: #777;
            --color-dark-gray: #333;
        }

        .toast {
            opacity: 0;
            transform: scale(0.95) translateY(-20px); /* Start slightly above and smaller */
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }

        .toast.show {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
         /* Estilização para select múltiplo se não usar Select2/TomSelect */
        select[multiple] {
            min-height: 100px; /* Para dar mais espaço visual */
            background-image: none; /* Remover setas de dropdown padrão em selects múltiplos */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // CORRIGIDO para usar o novo verde
                        'brasfi-blue': '#65a603',
                        'brasfi-blue-darker': '#528402', // Tom mais escuro do novo verde
                        'light-bg': '#f8f8f8',
                        'soft-gray': '#f0f2f5',
                        'medium-gray-text': '#777',
                        'dark-text': '#333',
                        'sidebar-bg': '#ffffff',
                        'card-bg': '#ffffff',
                        'tab-inactive': '#999',
                        // 'tab-active' será controlado pela classe .active e CSS customizado acima
                        'button-hover': '#e0e0e0',
                        // 'button-primary' e 'button-primary-hover' usarão 'brasfi-blue' e 'brasfi-blue-darker'
                        'input-border': '#ddd',
                        'shadow-light': 'rgba(0,0,0,0.05)',
                        'success-green': '#10B981',
                        'error-red': '#EF4444',
                    }
                }
            }
        }
    </script>
</head>
<body class="flex min-h-screen bg-gray-100 font-sans">

<div class="w-64 bg-sidebar-bg p-6 shadow-md flex flex-col justify-between">
    <div>
        <div class="flex items-center mb-8">
            <img th:src="@{/img/iconebrasfi.png}" alt="BRASFI Conecta Logo" class="h-12 w-15 mr-3">        </div>
        <nav>
            <ul>
                <li class="mb-2">
                    <a href="#" class="flex items-center p-3 rounded-lg text-medium-gray-text hover:bg-gray-100 hover:text-dark-text transition duration-200">
                         Dashboard
                    </a>
                </li>
                <li class="mb-2">
                    <a href="/trilhas/listar" class="flex items-center p-3 rounded-lg text-medium-gray-text hover:bg-gray-100 hover:text-dark-text transition duration-200">
                        Trilhas
                    </a>
                </li>
                <li class="mb-2"> <a class="flex items-center p-3 rounded-lg bg-[#65a603] text-white font-semibold transition duration-200">
                    Grupos
                </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="flex items-center p-3 rounded-lg text-medium-gray-text hover:bg-gray-100 hover:text-dark-text transition duration-200">
                        Projetos
                    </a>
                </li>
            </ul>
        </nav>
    </div>
    <div class="border-t border-gray-200 pt-4">
        <form th:action="@{/logout}" method="post" class="w-full">
            <button type="submit" class="flex items-center p-3 rounded-lg text-medium-gray-text hover:bg-red-100 hover:text-red-600 transition duration-200 w-full">
                <i class="fas fa-sign-out-alt mr-3 text-lg"></i> Sair
            </button>
        </form>
    </div>
</div>

<div class="flex-1 flex flex-col p-8 overflow-y-auto">
    <div id="toast-container" class="fixed top-5 right-5 z-[100] space-y-3">
    </div>

    <div class="flex justify-between items-center p-5 rounded-xl mb-8 sticky top-0 z-40">
        <div class="relative flex-1 mr-4">
            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input type="text" placeholder="Pesquise na plataforma..." class="w-full pl-12 pr-4 py-3 rounded-lg border border-input-border focus:outline-none focus:ring-1 focus:ring-brasfi-blue">
        </div>
        <div class="flex items-center space-x-6">
            <button class="text-gray-500 hover:text-brasfi-blue transition duration-200">
                <i class="fas fa-cog text-xl"></i>
            </button>
            <button class="text-gray-500 hover:text-brasfi-blue transition duration-200">
                <i class="fas fa-bell text-xl"></i>
            </button>
            <div th:if="${currentUser != null}" class="flex items-center ml-4 pl-4 border-l border-gray-200">
                <img th:src="${'https://via.placeholder.com/40x40?text=' + (#strings.isEmpty(currentUser.username) ? 'U' : #strings.substring(currentUser.username,0,1).toUpperCase())}" alt="User Profile" class="w-10 h-10 rounded-full mr-2 object-cover">
                <div>
                    <span class="font-semibold text-dark-text" th:text="${currentUser.nome ?: currentUser.username}">Usuário</span>
                    <small class="block text-medium-gray-text text-sm" th:text="${currentUser.tipoUsuario?.name() ?: 'Usuário'}">Cargo</small>
                </div>
            </div>
            <div th:if="${currentUser == null}" class="flex items-center ml-4 pl-4 border-l border-gray-200">
                <a th:href="@{/login}" class="text-brasfi-blue hover:underline">Login</a>
            </div>
        </div>
    </div>

    <h1 class="text-3xl font-bold text-dark-text mb-6">Grupos</h1>

    <div class="flex flex-1 gap-8">
        <div class="flex-1 flex flex-col">
            <h2 class="text-2xl font-semibold text-dark-text mb-6">Meus Grupos</h2>

            <div class="flex justify-between items-center mb-6 pb-2">
                <div class="flex border-b border-gray-200 pb-2">
                    <button class="tab-button active pb-3 px-4 font-medium transition duration-200 mr-4">Todos</button>
                    <button class="tab-button pb-3 px-4 text-tab-inactive hover:text-dark-text transition duration-200 mr-4">Fixados</button>
                    <button class="tab-button pb-3 px-4 text-tab-inactive hover:text-dark-text transition duration-200 mr-4">Não lidos</button>
                    <button th:if="${currentUser != null and currentUser.tipoUsuario == T(com.brasfi.platforma.model.TipoUsuario).ADMINISTRADOR}"
                            class="tab-button pb-3 px-4 text-tab-inactive hover:text-dark-text transition duration-200">Solicitações</button>
                </div>

                <div class="flex justify-between items-start mb-6 pb-2">
                    <div class="flex border-b border-gray-200 pb-2">
                    </div>
                    <div sec:authorize="hasRole('ADMINISTRADOR')">
                        <button id="openCriarGrupoModalBtn" type="button" class="flex items-center px-5 py-1 bg-brasfi-blue text-white rounded-lg hover:bg-brasfi-blue-darker transition duration-200">
                            <i class="fas fa-plus mr-2"></i> Novo Grupo
                        </button>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <div th:each="grupo : ${myGroups}" class="group-card bg-light-bg p-4 rounded-lg border border-gray-200 shadow-sm relative" th:data-group-id="${grupo.id}">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-brasfi-blue mb-1">
                                <span th:text="'#' + ${grupo.nome}">#Nome do Grupo</span>
                            </h3>
                            <p th:text="${grupo.descricao}" class="text-sm text-medium-gray-text line-clamp-2" th:title="${grupo.descricao}">Descrição do grupo</p>
                        </div>
                        <div class="flex items-center ml-4">
                            <div class="flex -space-x-2 avatar-group">
                                <th:block th:each="membro, iterStat : ${grupo.membros}" th:if="${grupo.membros != null and !#lists.isEmpty(grupo.membros) and iterStat.index < 3}">
                                    <img th:src="${'https://via.placeholder.com/28x28?text=' + (#strings.isEmpty(membro.username) ? 'M' : #strings.substring(membro.username,0,1).toUpperCase())}"
                                         th:alt="${membro.username}"
                                         th:title="${membro.username}"
                                         class="w-7 h-7 rounded-full border-2 border-white object-cover">
                                </th:block>
                                <span th:if="${grupo.membros != null and #lists.size(grupo.membros) > 3}"
                                      class="flex items-center justify-center w-7 h-7 rounded-full border-2 border-white bg-gray-200 text-gray-600 text-xs font-medium">
                                    <span th:text="'+' + (${#lists.size(grupo.membros)} - 3)"></span>
                                </span>
                                <span th:if="${grupo.membros == null or #lists.isEmpty(grupo.membros)}" class="text-xs font-medium text-gray-600 pl-2">
                                    0
                                </span>
                            </div>
                            <div class="relative ml-4">
                                <button class="kebab-menu-btn text-gray-500 hover:text-gray-700 focus:outline-none p-1 rounded-full hover:bg-gray-200 transition duration-150">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div class="dropdown-menu hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10 border border-gray-200">
                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 group-info-btn"
                                       th:data-group-id="${grupo.id}"
                                       th:data-group-name="${grupo.nome}"
                                       th:data-group-description="${grupo.descricao}">Informações</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Reportar Abuso</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center text-sm mt-3 border-t border-gray-100 pt-3"
                         th:if="${grupo.membros != null and !#lists.isEmpty(grupo.membros)}">
                        <span class="text-gray-600 truncate">
                            <strong th:text="${grupo.membros[0].username} + ':'">Usuário:</strong> Pode ser! Podemos tentar mais tarde.
                        </span>
                        <span class="text-gray-500 text-xs font-semibold bg-gray-200 px-3 py-1 rounded-full"
                              th:text="${#lists.size(grupo.membros)} + ' membros'">
                        </span>
                    </div>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md text-sm hover:bg-gray-300 transition duration-200">
                            <i class="fas fa-bookmark mr-1"></i> Fixar
                        </button>
                        <a href="/chat" class="flex items-center px-5 py-1 bg-brasfi-blue text-white rounded-lg hover:bg-brasfi-blue-darker transition duration-200">
                            Abrir
                        </a>
                    </div>
                </div>
                <div th:if="${#lists.isEmpty(myGroups)}" class="text-center text-gray-500 py-8">
                    Você ainda não faz parte de nenhum grupo. Explore abaixo!
                </div>
            </div>
        </div>

        <div th:if="${currentUser == null or currentUser.tipoUsuario != T(com.brasfi.platforma.model.TipoUsuario).ADMINISTRADOR}" class="flex-1 flex flex-col">
            <h2 class="text-2xl font-semibold text-dark-text mb-6">Navegue a BRASFI: <br>Explore novos grupos</h2>
            <div class="relative flex items-center mb-6">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" placeholder="Pesquisa por Grupos..." class="w-full pl-12 pr-4 py-3 rounded-lg border border-input-border focus:outline-none focus:ring-1 focus:ring-brasfi-blue">
                <button class="ml-3 px-5 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-200">
                    <i class="fas fa-filter mr-2"></i>Filtrar
                </button>
            </div>
            <div class="space-y-4">
                <div th:each="grupo : ${exploreGroups}" class="group-card bg-light-bg p-4 rounded-lg border border-gray-200 shadow-sm relative" th:data-group-id="${grupo.id}">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-semibold text-dark-text">
                            <span th:text="'#' + ${grupo.nome}">#Nome do Grupo</span>
                        </h3>
                        <div class="flex items-center ml-4">
                        </div>
                    </div>
                    <p th:text="${grupo.descricao}" class="text-sm text-medium-gray-text mb-4 line-clamp-3" th:title="${grupo.descricao}"></p>
                    <form th:if="${currentUser != null and currentUser.tipoUsuario != T(com.brasfi.platforma.model.TipoUsuario).ADMINISTRADOR}" th:action="@{'/grupo/solicitar_acesso/' + ${grupo.id}}" method="post" style="display:inline;">
                        <button type="submit" class="px-5 py-2 bg-brasfi-blue text-white rounded-lg hover:bg-brasfi-blue-darker transition duration-200 text-sm">
                            Solicitar acesso
                        </button>
                    </form>
                    <a th:if="${currentUser == null}" th:href="@{/login}" class="px-5 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-200 text-sm">
                        Login para solicitar
                    </a>
                </div>
                <div th:if="${#lists.isEmpty(exploreGroups)}" class="text-center text-gray-500 py-8">
                    Não há novos grupos para explorar no momento.
                </div>
            </div>
        </div>

        <div th:if="${currentUser != null and currentUser.tipoUsuario == T(com.brasfi.platforma.model.TipoUsuario).ADMINISTRADOR}" class="flex-1 flex flex-col">
            <h2 class="text-2xl font-semibold text-dark-text mb-6">Solicitações Pendentes</h2>
            <div class="relative flex items-center mb-6">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" placeholder="Pesquisar solicitações..." class="w-full pl-12 pr-4 py-3 rounded-lg border border-input-border focus:outline-none focus:ring-1 focus:ring-brasfi-blue">
            </div>
            <div class="space-y-4">
                <div th:each="solicitacao : ${pendingSolicitacoes}" class="solicitation-card bg-light-bg p-4 rounded-lg border border-gray-200 shadow-sm relative">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-semibold text-dark-text">
                            <span class="text-brasfi-blue" th:text="'#' + ${solicitacao.grupo.nome}">#Nome do Grupo</span>
                        </h3>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-user-circle mr-1"></i>
                            <span th:text="${solicitacao.solicitante.username}">Nome do Solicitante</span>
                        </div>
                    </div>
                    <p class="text-sm text-medium-gray-text mb-4">
                        Solicita acesso ao grupo.
                        <span th:if="${solicitacao.dataSolicitacao != null}" class="block text-xs text-gray-500 mt-1" th:text="${#temporals.format(solicitacao.dataSolicitacao, 'dd/MM/yyyy HH:mm')}">Data da solicitação</span>
                    </p>
                    <div class="mt-4 flex justify-end space-x-2">
                        <form th:action="@{'/grupo/aceitar_solicitacao/' + ${solicitacao.id}}" method="post" style="display:inline;">
                            <button type="submit" class="px-4 py-2 bg-success-green text-white rounded-md text-sm hover:bg-green-600 transition duration-200">
                                Aceitar
                            </button>
                        </form>
                        <form th:action="@{'/grupo/recusar_solicitacao/' + ${solicitacao.id}}" method="post" style="display:inline;">
                            <button type="submit" class="px-4 py-2 bg-error-red text-white rounded-md text-sm hover:bg-red-600 transition duration-200">
                                Recusar
                            </button>
                        </form>
                    </div>
                </div>
                <div th:if="${#lists.isEmpty(pendingSolicitacoes)}" class="text-center text-gray-500 py-8">
                    Não há solicitações pendentes no momento.
                </div>
            </div>
        </div>
    </div>
</div>

<div id="membersModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-4 sm:mx-0">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h3 class="text-xl font-semibold text-gray-800">Informações sobre o grupo</h3>
            <button id="closeMembersInfoModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl"> &times;
            </button>
        </div>
        <div class="mb-4">
            <h4 id="modalGroupTitle" class="text-lg font-semibold text-brasfi-blue mb-1"></h4>
            <p id="modalGroupDescription" class="text-sm text-gray-600 mb-3"></p>
            <div class="relative">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="memberSearchInput" placeholder="Buscar membros..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-brasfi-blue">
            </div>
        </div>
        <div class="max-h-80 overflow-y-auto">
            <ul id="membersList" class="space-y-3">
            </ul>
        </div>
    </div>
</div>


<div sec:authorize="hasRole('ADMINISTRADOR')">
    <div id="criarGrupoModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[60] hidden">
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-lg mx-4 sm:mx-0 transform transition-all duration-300 ease-out scale-95 opacity-0"
             id="criarGrupoModalContent">
            <div class="flex justify-between items-center mb-6 border-b border-gray-200 pb-4">
                <h3 class="text-2xl font-semibold text-dark-text">Criar Novo Grupo</h3>
                <button id="closeCriarGrupoModalBtn" class="text-gray-400 hover:text-gray-600 transition duration-150">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="criarGrupoModalAlertPlaceholder" class="mb-4"></div>
            <form id="formCriarGrupo">
                <div class="mb-5">
                    <label for="grupoNomeModal" class="block text-sm font-medium text-gray-700 mb-1">Nome do Grupo <span class="text-red-500">*</span></label>
                    <input type="text" id="grupoNomeModal" name="nome" required
                           class="w-full px-4 py-2.5 border border-input-border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-brasfi-blue focus:border-transparent placeholder-gray-400"
                           placeholder="Ex: Desenvolvimento Frontend Avançado">
                    <div id="grupoNomeModalError" class="text-red-500 text-xs mt-1 hidden">O nome do grupo é obrigatório.</div>
                </div>
                <div class="mb-5">
                    <label for="grupoDescricaoModal" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                    <textarea id="grupoDescricaoModal" name="descricao" rows="3"
                              class="w-full px-4 py-2.5 border border-input-border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-brasfi-blue focus:border-transparent placeholder-gray-400"
                              placeholder="Descreva o propósito, tópicos principais e quem pode se interessar pelo grupo..."></textarea>
                </div>
                <div class="mb-6" th:if="${allUsersForModal != null}">
                    <label for="grupoMembrosModal" class="block text-sm font-medium text-gray-700 mb-1">Adicionar Membros (opcional)</label>
                    <select multiple id="grupoMembrosModal" name="membrosIds"
                            class="w-full px-3 py-2 border border-input-border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-brasfi-blue focus:border-transparent bg-white">
                        <th:block th:each="usuario : ${allUsersForModal}">
                            <option th:if="${currentUser == null || !usuario.id.equals(currentUser.id)}"
                                    th:value="${usuario.id}"
                                    th:text="${usuario.username + (usuario.nome != null ? ' (' + usuario.nome + ')' : '')}">
                            </option>
                        </th:block>
                    </select>
                    <p class="text-xs text-gray-500 mt-1.5">O criador é adicionado automaticamente. Segure Ctrl/Cmd para selecionar múltiplos usuários.</p>
                </div>
                <div class="flex justify-end space-x-3 border-t border-gray-200 pt-6 mt-8">
                    <button type="button" id="cancelCriarGrupoModalBtn" class="px-5 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150">
                        Cancelar
                    </button>
                    <button type="button" id="btnSalvarGrupoModal" class="px-5 py-2.5 text-sm font-medium text-white bg-brasfi-blue rounded-lg hover:bg-brasfi-blue-darker focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brasfi-blue transition duration-150 flex items-center justify-center">
                        <i class="fas fa-plus mr-2"></i> Criar Grupo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


<script th:inline="javascript">
    /*<![CDATA[*/
    let currentGroupMembers = [];
    let toastTimeout;

    function showToast(message, type) {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) return;
        const existingToast = document.getElementById('dynamic-toast');
        if (existingToast) {
            existingToast.remove();
            clearTimeout(toastTimeout);
        }
        const toastElement = document.createElement('div');
        toastElement.id = 'dynamic-toast';
        toastElement.classList.add(
            'px-6', 'py-4', 'rounded-lg', 'shadow-xl', 'flex', 'items-center', 'text-base',
            'transition-all', 'duration-300', 'ease-in-out', 'transform', 'toast'
        );
        let iconHtml = '';
        if (type === 'success') {
            toastElement.classList.add('bg-success-green', 'text-white'); // Usando cor do Tailwind config
            iconHtml = '<i class="fas fa-check-circle mr-3 text-xl"></i>';
        } else if (type === 'error') {
            toastElement.classList.add('bg-error-red', 'text-white'); // Usando cor do Tailwind config
            iconHtml = '<i class="fas fa-exclamation-circle mr-3 text-xl"></i>';
        } else { // info or default
            toastElement.classList.add('bg-brasfi-blue', 'text-white'); // CORRIGIDO: Usando brasfi-blue (que agora é verde)
            iconHtml = '<i class="fas fa-info-circle mr-3 text-xl"></i>';
        }
        toastElement.innerHTML = iconHtml + '<span>' + message + '</span>';
        toastContainer.appendChild(toastElement);
        requestAnimationFrame(() => {
            toastElement.classList.add('show');
        });
        toastTimeout = setTimeout(() => {
            toastElement.classList.remove('show');
            setTimeout(() => {
                if (toastElement.parentNode) {
                    toastElement.remove();
                }
            }, 350);
        }, 5000);
    }

    document.addEventListener('DOMContentLoaded', () => {
        const successMessageAttr = /*[[${successMessage}]]*/ null;
        const errorMessageAttr = /*[[${errorMessage}]]*/ null;
        if (successMessageAttr) {
            showToast(successMessageAttr, 'success');
        } else if (errorMessageAttr) {
            showToast(errorMessageAttr, 'error');
        }

        const kebabMenuBtns = document.querySelectorAll('.kebab-menu-btn');
        kebabMenuBtns.forEach(button => {
            button.addEventListener('click', (event) => {
                event.stopPropagation();
                const dropdown = button.nextElementSibling;
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    if (menu !== dropdown && !menu.classList.contains('hidden')) {
                        menu.classList.add('hidden');
                    }
                });
                dropdown.classList.toggle('hidden');
            });
        });
        document.addEventListener('click', (event) => {
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                if (menu.previousElementSibling && !menu.contains(event.target) && !menu.previousElementSibling.contains(event.target)) {
                    menu.classList.add('hidden');
                }
            });
        });

        const membersModalEl = document.getElementById('membersModal');
        const modalGroupTitleSpan = document.getElementById('modalGroupTitle');
        const modalGroupDescriptionParagraph = document.getElementById('modalGroupDescription');
        const memberSearchInput = document.getElementById('memberSearchInput');
        const closeMembersInfoModalBtnEl = document.getElementById('closeMembersInfoModalBtn');


        document.querySelectorAll('.group-info-btn').forEach(button => {
            button.addEventListener('click', (event) => {
                event.preventDefault();
                event.stopPropagation();
                const groupId = event.target.dataset.groupId;
                const groupName = event.target.dataset.groupName;
                const groupDescription = event.target.dataset.groupDescription;
                if(modalGroupTitleSpan) modalGroupTitleSpan.textContent = `#${groupName}`;
                if(modalGroupDescriptionParagraph) modalGroupDescriptionParagraph.textContent = groupDescription;
                if(memberSearchInput) memberSearchInput.value = '';
                currentGroupMembers = [];
                fetchMembersForGroup(groupId);
                closeAllDropdowns();
                if(membersModalEl) membersModalEl.classList.remove('hidden');
            });
        });
        if(closeMembersInfoModalBtnEl) {
            closeMembersInfoModalBtnEl.addEventListener('click', closeMembersInfoModal);
        }
        if (memberSearchInput) {
            memberSearchInput.addEventListener('keyup', searchMembers);
        }

        const criarGrupoModalEl = document.getElementById('criarGrupoModal');
        const criarGrupoModalContentEl = document.getElementById('criarGrupoModalContent');
        const openCriarGrupoModalBtnEl = document.getElementById('openCriarGrupoModalBtn');
        const closeCriarGrupoModalBtnEl = document.getElementById('closeCriarGrupoModalBtn');
        const cancelCriarGrupoModalBtnEl = document.getElementById('cancelCriarGrupoModalBtn');
        const btnSalvarGrupoModalEl = document.getElementById('btnSalvarGrupoModal');
        const formCriarGrupoEl = document.getElementById('formCriarGrupo');
        const grupoNomeModalInputEl = document.getElementById('grupoNomeModal');
        const grupoMembrosModalSelectEl = document.getElementById('grupoMembrosModal');
        const grupoNomeModalErrorEl = document.getElementById('grupoNomeModalError');
        const criarGrupoModalAlertPlaceholderEl = document.getElementById('criarGrupoModalAlertPlaceholder');
        console.log('Botão "Novo Grupo" (openCriarGrupoModalBtnEl):', openCriarGrupoModalBtnEl);
        console.log('Elemento Principal do Modal (criarGrupoModalEl):', criarGrupoModalEl);
        console.log('Elemento de Conteúdo do Modal (criarGrupoModalContentEl):', criarGrupoModalContentEl);
        console.log('Formulário do Modal (formCriarGrupoEl):', formCriarGrupoEl);
        console.log('Select de Membros do Modal (grupoMembrosModalSelectEl):', grupoMembrosModalSelectEl);


        function openCriarGrupoModal() {
            console.log('Função openCriarGrupoModal FOI CHAMADA!');
            console.log('Dentro de open: criarGrupoModalEl =', criarGrupoModalEl);

            if (criarGrupoModalEl && criarGrupoModalContentEl) {
                if(formCriarGrupoEl) {
                    formCriarGrupoEl.reset();
                    console.log('Formulário resetado.');
                } else {
                    console.warn('formCriarGrupoEl NÃO encontrado dentro de openCriarGrupoModal ao tentar resetar!');
                }

                if (grupoMembrosModalSelectEl) {
                    Array.from(grupoMembrosModalSelectEl.options).forEach(option => option.selected = false);
                    console.log('Select de membros resetado.');
                } else {
                    console.warn('grupoMembrosModalSelectEl não encontrado ou nulo ao tentar resetar.');
                }

                if(grupoNomeModalInputEl) grupoNomeModalInputEl.classList.remove('border-red-500', 'focus:ring-red-500');
                if(grupoNomeModalErrorEl) grupoNomeModalErrorEl.classList.add('hidden');
                if(criarGrupoModalAlertPlaceholderEl) criarGrupoModalAlertPlaceholderEl.innerHTML = '';

                criarGrupoModalEl.classList.remove('hidden');
                console.log('Classe "hidden" REMOVIDA do criarGrupoModalEl.');

                requestAnimationFrame(() => {
                    criarGrupoModalContentEl.classList.remove('scale-95', 'opacity-0');
                    criarGrupoModalContentEl.classList.add('scale-100', 'opacity-100');
                    console.log('Classes de animação aplicadas ao criarGrupoModalContentEl.');
                });
            } else {
                console.error('ERRO FATAL: criarGrupoModalEl ou criarGrupoModalContentEl são NULOS dentro de openCriarGrupoModal!');
                if (!criarGrupoModalEl) console.error("criarGrupoModalEl é NULO!");
                if (!criarGrupoModalContentEl) console.error("criarGrupoModalContentEl é NULO!");
            }
        }

        function closeCriarGrupoModal() {
            console.log('Função closeCriarGrupoModal FOI CHAMADA!');
            if (criarGrupoModalEl && criarGrupoModalContentEl) {
                 criarGrupoModalContentEl.classList.remove('scale-100', 'opacity-100');
                 criarGrupoModalContentEl.classList.add('scale-95', 'opacity-0');
                 setTimeout(() => {
                    criarGrupoModalEl.classList.add('hidden');
                    console.log('Classe "hidden" ADICIONADA ao criarGrupoModalEl após delay.');
                 }, 300);
            }  else {
                console.error('ERRO: criarGrupoModalEl ou criarGrupoModalContentEl não foram encontrados ao tentar fechar o modal!');
            }
        }

        if (openCriarGrupoModalBtnEl) {
            openCriarGrupoModalBtnEl.addEventListener('click', openCriarGrupoModal);
            console.log('Listener de clique ADICIONADO ao openCriarGrupoModalBtnEl.');
        } else {
            console.warn('AVISO: Botão openCriarGrupoModalBtnEl não encontrado inicialmente.');
        }

        if (closeCriarGrupoModalBtnEl) {
            closeCriarGrupoModalBtnEl.addEventListener('click', closeCriarGrupoModal);
        } else {
            console.warn('Botão closeCriarGrupoModalBtnEl (X) não encontrado.');
        }

        if (cancelCriarGrupoModalBtnEl) {
            cancelCriarGrupoModalBtnEl.addEventListener('click', closeCriarGrupoModal);
        } else {
            console.warn('Botão cancelCriarGrupoModalBtnEl não encontrado.');
        }

        if(criarGrupoModalEl) {
            criarGrupoModalEl.addEventListener('click', (event) => {
                if (event.target === criarGrupoModalEl) {
                    closeCriarGrupoModal();
                }
            });
        }

        if (btnSalvarGrupoModalEl && formCriarGrupoEl) {
            btnSalvarGrupoModalEl.addEventListener('click', async () => {
                const nome = formCriarGrupoEl.elements.nome.value.trim();
                const descricao = formCriarGrupoEl.elements.descricao.value.trim();
                let membrosIds = [];
                if (grupoMembrosModalSelectEl) {
                     membrosIds = Array.from(grupoMembrosModalSelectEl.selectedOptions).map(option => option.value);
                }
                if (!nome) {
                    if(grupoNomeModalInputEl) grupoNomeModalInputEl.classList.add('border-red-500','focus:ring-red-500');
                    if(grupoNomeModalErrorEl) grupoNomeModalErrorEl.classList.remove('hidden');
                    return;
                } else {
                    if(grupoNomeModalInputEl) grupoNomeModalInputEl.classList.remove('border-red-500','focus:ring-red-500');
                    if(grupoNomeModalErrorEl) grupoNomeModalErrorEl.classList.add('hidden');
                }
                if(criarGrupoModalAlertPlaceholderEl) criarGrupoModalAlertPlaceholderEl.innerHTML = '';
                const grupoData = { nome, descricao, membrosIds };
                const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
                const headers = { 'Content-Type': 'application/json' };
                if (csrfToken && csrfHeader) {
                    headers[csrfHeader] = csrfToken;
                }
                const originalButtonHtml = btnSalvarGrupoModalEl.innerHTML;
                btnSalvarGrupoModalEl.disabled = true;
                btnSalvarGrupoModalEl.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Criando...`;
                try {
                    const response = await fetch(/*[[@{/grupo/criar_grupo_modal}]]*/ '/grupo/criar_grupo_modal', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(grupoData)
                    });
                    const responseData = await response.json();
                    if (response.ok) {
                        closeCriarGrupoModal();
                        showToast(responseData.message || 'Grupo criado com sucesso!', 'success');
                        setTimeout(() => window.location.reload(), 1800);
                    } else {
                        const errorMsg = responseData.message || `Erro ${response.status}: Não foi possível criar o grupo.`;
                         if(criarGrupoModalAlertPlaceholderEl) {
                             criarGrupoModalAlertPlaceholderEl.innerHTML = `
                                <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert">
                                    <p class="font-bold">Falha na Criação</p>
                                    <p>${errorMsg}</p>
                                </div>`;
                         } else { showToast(errorMsg, 'error'); }
                    }
                } catch (error) {
                    console.error('Erro na requisição AJAX:', error);
                    if(criarGrupoModalAlertPlaceholderEl) {
                        criarGrupoModalAlertPlaceholderEl.innerHTML = `
                            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert">
                                <p class="font-bold">Erro de Conexão</p>
                                <p>Não foi possível comunicar com o servidor. Verifique sua conexão e tente novamente.</p>
                            </div>`;
                    } else { showToast('Erro de comunicação ao tentar criar o grupo.', 'error'); }
                } finally {
                     btnSalvarGrupoModalEl.disabled = false;
                     btnSalvarGrupoModalEl.innerHTML = originalButtonHtml;
                }
            });
        } else {
            if (!btnSalvarGrupoModalEl && document.getElementById('btnSalvarGrupoModal')) console.warn("Botão Salvar (btnSalvarGrupoModalEl) foi encontrado no DOM, mas a variável JS é nula ou o form é nulo.");
            else if (!btnSalvarGrupoModalEl) console.warn("Botão Salvar (btnSalvarGrupoModalEl) não encontrado.");

            if (!formCriarGrupoEl && document.getElementById('formCriarGrupo')) console.warn("Formulário (formCriarGrupoEl) foi encontrado no DOM, mas a variável JS é nula ou o botão salvar é nulo.");
            else if (!formCriarGrupoEl) console.warn("Formulário (formCriarGrupoEl) para salvar não encontrado.");
        }
    });

    function closeMembersInfoModal() {
        const membersModal = document.getElementById('membersModal');
        const membersList = document.getElementById('membersList');
        const memberSearchInput = document.getElementById('memberSearchInput');
        if(membersModal) membersModal.classList.add('hidden');
        if(membersList) membersList.innerHTML = '';
        if(memberSearchInput) memberSearchInput.value = '';
        currentGroupMembers = [];
    }
    function closeAllDropdowns() {
        document.querySelectorAll('.dropdown-menu').forEach(menu => menu.classList.add('hidden'));
    }
    async function fetchMembersForGroup(groupId) {
        const membersListElement = document.getElementById('membersList');
        if(!membersListElement) return;
        membersListElement.innerHTML = '<li class="text-center text-gray-500 p-4">Carregando membros...</li>';
        try {
            const response = await fetch(/*[[@{'/grupo/'}]]*/'/grupo/' + groupId + '/membros');
            console.log("Attempting to fetch from URL:", url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const members = await response.json();
            currentGroupMembers = members;
            renderMembers(currentGroupMembers);
        } catch (error) {
            console.error("Erro ao carregar membros:", error);
            membersListElement.innerHTML = '<li class="text-center text-red-500 p-4">Erro ao carregar membros. Tente novamente.</li>';
        }
    }
    function renderMembers(membersToRender) {
        const membersListElement = document.getElementById('membersList');
        if (!membersListElement) return;
        membersListElement.innerHTML = '';
        if (membersToRender.length === 0) {
            membersListElement.innerHTML = '<li class="text-center text-gray-500 p-4">Nenhum membro encontrado.</li>';
        } else {
            membersToRender.forEach(member => {
                const listItem = document.createElement('li');
                listItem.className = 'flex items-center space-x-3 p-3 hover:bg-gray-100 rounded-md transition duration-150';
                const initials = member.nome ? member.nome.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase() : (member.username ? member.username.substring(0,1).toUpperCase() : '?');
                listItem.innerHTML = `
                        <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center text-sm font-semibold object-cover">
                           ${initials}
                        </div>
                        <div>
                            <span class="text-gray-800 font-medium">${member.nome || member.username || 'Nome não disponível'}</span>
                            <span class="block text-gray-500 text-xs">${member.email || ''}</span>
                        </div>
                    `;
                membersListElement.appendChild(listItem);
            });
        }
    }
    function searchMembers() {
        const searchInput = document.getElementById('memberSearchInput');
        if(!searchInput) return;
        const searchTerm = searchInput.value.toLowerCase();
        const filteredMembers = currentGroupMembers.filter(member => {
            const memberName = member.nome ? member.nome.toLowerCase() : '';
            const memberUsername = member.username ? member.username.toLowerCase() : '';
            const memberEmail = member.email ? member.email.toLowerCase() : '';
            return memberName.includes(searchTerm) || memberUsername.includes(searchTerm) || memberEmail.includes(searchTerm);
        });
        renderMembers(filteredMembers);
    }
    /*]]>*/
</script>

</body>
</html>